<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatórios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
    }

    .table thead th {
      background-color: var(--bs-tertiary-bg);
    }

    .dark-toggle {
      cursor: pointer;
    }
  </style>
</head>
<body class="p-4">

  <!-- Navbar com toggle de dark mode -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Relatórios de Rotas e Usuários</h2>
    <div>
      <span class="dark-toggle me-2"><i class="bi bi-moon-stars-fill"></i></span>
      <button class="btn btn-outline-primary" onclick="window.location.href='index.html'">Voltar</button>
    </div>
  </div>
<div class="row g-3 mb-4" id="cardsEstatisticas">
  <div class="col-md-3">
    <div class="card text-bg-primary shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Total de Rotas</h6>
        <h3 id="cardTotalRotas">--</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-secondary shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Total de Usuários</h6>
        <h3 id="cardTotalUsuarios">--</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-bg-success shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Normal</h6>
        <h4 id="cardNormal">--</h4>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-bg-warning shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Ausente</h6>
        <h4 id="cardAusente">--</h4>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-bg-danger shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Desligado</h6>
        <h4 id="cardDesligado">--</h4>
      </div>
    </div>
  </div>
</div>

  <!-- Filtros -->
  <div class="row mb-3 g-2">
    <div class="col-md-4">
      <input type="text" id="filtroNome" class="form-control" placeholder="Buscar por nome do usuário">
    </div>
    <div class="col-md-4">
      <input type="text" id="filtroRota" class="form-control" placeholder="Buscar por nome da rota">
    </div>
    <div class="col-md-4">
      <select id="filtroStatus" class="form-select">
        <option value="">Todos os status</option>
        <option value="Normal">Normal</option>
        <option value="Ausente">Ausente</option>
        <option value="Desligado">Desligado</option>
      </select>
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Usuário</th>
          <th>Status</th>
          <th>Rota</th>
          <th>Origem</th>
          <th>Destino</th>
          <th>Data</th>
          <th>Hora</th>
        </tr>
      </thead>
      <tbody id="tabelaRelatorios">
        <!-- Dados via JS -->
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "http://127.0.0.1:5000/api";

async function carregarRelatorios() {
  try {
    const res = await fetch(`${API_URL}/relatorios`);
    if (!res.ok) throw new Error("Erro na API");

    const json = await res.json();
    const dados = json.dados;
    const estatisticas = json.estatisticas;

    renderizarTabela(dados);
    atualizarCards(estatisticas);
  } catch (err) {
    alert("Erro ao carregar dados: " + err.message);
  }
}



    function renderizarTabela(dados) {
      const tbody = document.getElementById("tabelaRelatorios");
      tbody.innerHTML = "";

      const nomeFiltro = document.getElementById("filtroNome").value.toLowerCase();
      const rotaFiltro = document.getElementById("filtroRota").value.toLowerCase();
      const statusFiltro = document.getElementById("filtroStatus").value;

      const filtrado = dados.filter(item => {
        return (
          item.nome.toLowerCase().includes(nomeFiltro) &&
          item.rota.toLowerCase().includes(rotaFiltro) &&
          (statusFiltro === "" || item.status === statusFiltro)
        );
      });

      filtrado.forEach((r, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${r.nome}</td>
          <td>${r.status}</td>
          <td>${r.rota}</td>
          <td>${r.origem_lat}, ${r.origem_lon}</td>
          <td>${r.destino_lat}, ${r.destino_lon}</td>
          <td>${r.data}</td>
          <td>${r.hora}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.querySelectorAll("#filtroNome, #filtroRota, #filtroStatus").forEach(el => {
      el.addEventListener("input", carregarRelatorios);
    });

    // Dark Mode Toggle
    document.querySelector(".dark-toggle").addEventListener("click", () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute("data-bs-theme");
      html.setAttribute("data-bs-theme", currentTheme === "dark" ? "light" : "dark");
    });
    function atualizarCards(est) {
      document.getElementById("cardTotalRotas").textContent = est.total_rotas;
      document.getElementById("cardTotalUsuarios").textContent = est.total_usuarios;
      document.getElementById("cardNormal").textContent = `${est.por_status.Normal} (${est.percentuais.Normal})`;
      document.getElementById("cardAusente").textContent = `${est.por_status.Ausente} (${est.percentuais.Ausente})`;
      document.getElementById("cardDesligado").textContent = `${est.por_status.Desligado} (${est.percentuais.Desligado})`;
    }

    window.addEventListener("DOMContentLoaded", carregarRelatorios);
  </script>
</body>
</html>
